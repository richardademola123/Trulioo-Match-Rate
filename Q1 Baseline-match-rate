-- Purpose: Calculate match rate per country using Q1 rule
-- Output: Country, total_records, matched_records_q1, match_rate_q1
-- Notes:
--   - MatchStatusID: 2=match, 3=nomatch, else missing
--   - A record matches if any datasource has Name match AND (Address match OR DOB match)

WITH field_flags AS (
-- Convert MatchStatusID into usablw flags for aggregation 
  SELECT
    Country,
    RecordID,
    Datasource,
    Field,
    MatchStatusID,
    CASE WHEN MatchStatusID = 2 THEN 1 ELSE 0 END AS is_match,
    CASE WHEN MatchStatusID = 3 THEN 1 ELSE 0 END AS is_nomatch
  FROM `vibrant-sound-459613-a3.trulioo.Field_table `
),

per_ds AS (
-- one row per (Country, RecordID, Datasource) with term-level  match flags 
  SELECT
    Country,
    RecordID,
    Datasource,

--NAME: FirstName AND LastName match 
    CASE 
      WHEN SUM(CASE WHEN Field = 'FirstName' AND is_match = 1 THEN 1 ELSE 0 END) > 0
       AND SUM(CASE WHEN Field = 'LastName'  AND is_match = 1 THEN 1 ELSE 0 END) > 0
      THEN 1 ELSE 0
    END AS name_match,

--DateofBirth: Dayofbirth AND monthofbirth AND YearofBirth match 
    CASE 
      WHEN SUM(CASE WHEN Field = 'DayOfBirth'   AND is_match = 1 THEN 1 ELSE 0 END) > 0
       AND SUM(CASE WHEN Field = 'MonthOfBirth' AND is_match = 1 THEN 1 ELSE 0 END) > 0
       AND SUM(CASE WHEN Field = 'YearOfBirth'  AND is_match = 1 THEN 1 ELSE 0 END) > 0
      THEN 1 ELSE 0
    END AS dob_match,
--Address: StreetName AND HouseNumber AND (postalcode OR city) match,
-- and unitNumber is NOT a nomatch (MatchStatudID =3)

    CASE 
      WHEN SUM(CASE WHEN Field = 'StreetName'   AND is_match = 1 THEN 1 ELSE 0 END) > 0
       AND SUM(CASE WHEN Field = 'HouseNumber'  AND is_match = 1 THEN 1 ELSE 0 END) > 0
       AND (
             SUM(CASE WHEN Field = 'PostalCode' AND is_match = 1 THEN 1 ELSE 0 END) > 0
          OR SUM(CASE WHEN Field = 'City'       AND is_match = 1 THEN 1 ELSE 0 END) > 0
       )
       AND SUM(CASE WHEN Field = 'UnitNumber' AND is_nomatch = 1 THEN 1 ELSE 0 END) = 0
      THEN 1 ELSE 0
    END AS address_match
  FROM field_flags
  GROUP BY
    Country,
    RecordID,
    Datasource
),

per_record AS (
-- one row per (Country,RecordID). record matches if AMY datasources meets the rule. 
  SELECT
    Country,
    RecordID,
    CASE
      WHEN SUM(
        CASE 
          WHEN name_match = 1
           AND (address_match = 1 OR dob_match = 1)
          THEN 1 ELSE 0
        END
      ) > 0
      THEN 1 ELSE 0
    END AS record_match_q1
  FROM per_ds
  GROUP BY
    Country,
    RecordID
),

joined AS (
--Keep all transactions in the denominator 
  SELECT
    r.Country,
    r.RecordID,
    pr.record_match_q1
  FROM `vibrant-sound-459613-a3.trulioo.Record_table` r
  LEFT JOIN per_record pr
    ON r.Country = pr.Country
   AND r.RecordID = pr.RecordID
)

SELECT
  Country,
  COUNT(*) AS total_records,
  SUM(record_match_q1) AS matched_records_q1,
  SAFE_DIVIDE(SUM(record_match_q1), COUNT(*)) AS match_rate_q1
FROM joined
GROUP BY Country
ORDER BY Country;


